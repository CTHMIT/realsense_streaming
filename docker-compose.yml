version: "3.8"

services:
  orin:
    image: robot-vision-system:orin-${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile.orin
      target: runtime
      args:
        ROS_DISTRO: ${ROS_DISTRO:-humble}
        USER_ID: ${USER_ID:-11408161}
        GROUP_ID: ${GROUP_ID:-670}
        USERNAME: ${USERNAME:-cthsu}
    platform: linux/arm64
    container_name: orin
    hostname: orin
    privileged: true
    runtime: nvidia
    network_mode: host
    profiles: [orin, client]
    gpus: all
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-161}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_cyclonedds_cpp}
      - CYCLONEDDS_URI=${CYCLONEDDS_URI_ORIN:-file:///workspace/src/client/bringup/config/dds/cyclonedds_orin.xml}
      - ROS_LOCALHOST_ONLY=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROBOT_NAMESPACE=${ROBOT_NAMESPACE:-}
      - SERVER_IP=${SERVER_IP:-10.28.121.28}
    volumes:
      - ./src:/workspace/src:rw
      - ./config:/workspace/config:rw
      - /dev:/dev:rw
      - /etc/udev/rules.d:/etc/udev/rules.d:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - orin-data:/home/ros/.ros:rw
    command: >
      bash -lc "
        source /opt/ros/${ROS_DISTRO:-humble}/setup.bash &&
        [ -f /workspace/install/setup.bash ] && source /workspace/install/setup.bash || true &&
        ros2 launch client orin.launch.py robot_namespace:=${ROBOT_NAMESPACE:-}
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'command -v ros2 >/dev/null && ros2 node list >/dev/null'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  server:
    image: robot-vision-system:server-${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile.server
      args:
        ROS_DISTRO: ${ROS_DISTRO:-humble}
        CUDA_VERSION: ${CUDA_VERSION:-12.6.3}
        USER_ID: ${USER_ID:-11408161}
        GROUP_ID: ${GROUP_ID:-670}
        USERNAME: ${USERNAME:-cthsu}
    platform: linux/amd64
    container_name: server
    hostname: server
    privileged: false
    network_mode: host
    profiles: [server]
    gpus: all
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-161}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_cyclonedds_cpp}
      - CYCLONEDDS_URI=${CYCLONEDDS_URI_SERVER:-file:///workspace/src/server/bringup/config/dds/cyclonedds_server.xml}
      - ROS_LOCALHOST_ONLY=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - LIBGL_ALWAYS_SOFTWARE=0
      - ROBOT_NAMESPACE=${ROBOT_NAMESPACE:-}
      - ORIN_IP=${ORIN_IP:-10.28.134.61}
    volumes:
      - ./src:/workspace/src:rw
      - ./config:/workspace/config:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/home/ros/.Xauthority:ro
      - server-data:/home/ros/.ros:rw
      - /dev/shm:/dev/shm:rw
    command: >
      bash -lc "
        source /opt/ros/${ROS_DISTRO:-humble}/setup.bash &&
        [ -f /workspace/install/setup.bash ] && source /workspace/install/setup.bash || true &&
        ros2 launch server server.launch.py robot_namespace:=${ROBOT_NAMESPACE:-}
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'command -v ros2 >/dev/null && ros2 node list >/dev/null'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    shm_size: "16g"

  rviz:
    image: robot-vision-system:server-${VERSION:-latest}
    container_name: rviz
    hostname: rviz
    network_mode: host
    profiles: [viz, visualization]
    gpus: all
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-161}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_cyclonedds_cpp}
      - ROS_LOCALHOST_ONLY=0
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      - ./src:/workspace/src:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/home/ros/.Xauthority:ro
    command: >
      bash -lc "
        source /opt/ros/${ROS_DISTRO:-humble}/setup.bash &&
        [ -f /workspace/install/setup.bash ] && source /workspace/install/setup.bash || true &&
        ros2 launch server camera_visualization.launch.py
      "

volumes:
  orin-data: {}
  server-data: {}
